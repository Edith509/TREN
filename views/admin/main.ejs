<% layout("/admin/layout.ejs") %>

<section class="grid gap-6 animate-[fadeSlide_0.45s_ease]">
  <section class="rounded-2xl border border-slate-200 bg-white p-6">
    <h1 class="text-xl font-semibold text-slate-900">Главная</h1>
    <p class="mt-2 text-sm text-slate-500">Сводка по заявкам и ближайшим тренировкам.</p>
  </section>

  <section class="grid gap-6 md:grid-cols-[1.1fr_1fr]">
    <div class="rounded-2xl border border-slate-200 bg-white p-6" id="adminProfile">
      <div class="flex items-center gap-4">
        <div class="relative flex h-14 w-14 items-center justify-center rounded-xl bg-slate-100 text-lg font-semibold text-slate-500">
          ?
        </div>
        <div>
          <div class="text-base font-semibold text-slate-900">Админ не найден</div>
          <div class="text-sm text-slate-500">Проверьте ADMIN_TELEGRAM_ID</div>
        </div>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white p-6">
      <h3 class="text-base font-semibold text-slate-900">Сводка</h3>
      <div class="mt-4 divide-y divide-slate-100 text-sm" id="summaryStats">
        <div class="flex items-center justify-between py-2 text-slate-500">
          <span>Заявок на рассмотрении</span>
          <span class="font-semibold text-slate-900">0</span>
        </div>
        <div class="flex items-center justify-between py-2 text-slate-500">
          <span>Принятых тренировок</span>
          <span class="font-semibold text-slate-900">0</span>
        </div>
        <div class="flex items-center justify-between py-2 text-slate-500">
          <span>Активных целей</span>
          <span class="font-semibold text-slate-900">0</span>
        </div>
      </div>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-200 bg-white p-6">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <h3 class="text-base font-semibold text-slate-900">Принятые планы</h3>
      <div class="flex flex-wrap gap-2">
        <button
          id="tabTrainingPlans"
          class="rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700"
          type="button"
        >
          Тренировки
        </button>
        <button
          id="tabNutritionPlans"
          class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-500"
          type="button"
        >
          Питание
        </button>
      </div>
    </div>
    <div class="mt-4 grid gap-3" id="trainingList">
      <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
        Загружаем тренировки...
      </div>
    </div>
    <div class="mt-4 hidden grid gap-3" id="nutritionList">
      <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
        Загружаем планы питания...
      </div>
    </div>
  </section>
</section>

<script>
  const adminId = document.body.dataset.adminId;
  const initData = window.Telegram?.WebApp?.initData || "";
  const initHeaders = initData ? { "x-telegram-init-data": initData } : {};
  const query = adminId ? `?adminTelegramId=${adminId}` : "";

  const statusLabels = {
    accepted: "Принято",
    pending: "Ожидает",
    declined: "Отклонено",
    completed: "Завершено",
  };

  const statusClasses = {
    accepted: "border border-emerald-200 bg-emerald-50 text-emerald-700",
    pending: "border border-blue-200 bg-blue-50 text-blue-700",
    declined: "border border-rose-200 bg-rose-50 text-rose-600",
    completed: "border border-indigo-200 bg-indigo-50 text-indigo-700",
  };

  function formatDate(value) {
    if (!value) return "Дата не задана";
    const date = new Date(value);
    return date.toLocaleString("ru-RU", {
      day: "2-digit",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    });
  }

  function getInitials(profile) {
    const first = profile?.firstName?.[0] || "";
    const last = profile?.lastName?.[0] || "";
    return `${first}${last}`.trim() || "?";
  }

  function renderAvatarImage(photoUrl, telegramId, initials, altText) {
    const fallbackSrc = telegramId ? `/api/telegram/avatar/${telegramId}` : "";
    const src = photoUrl || fallbackSrc;
    if (!src) return initials;
    const fallbackAttr = fallbackSrc && src !== fallbackSrc ? ` data-fallback="${fallbackSrc}"` : "";
    const onError = "if (this.dataset.fallback){this.src=this.dataset.fallback;this.removeAttribute('data-fallback');}else{this.remove();}";
    const img = `<img class="absolute inset-0 h-full w-full object-cover" src="${src}" alt="${altText}" onerror="${onError}"${fallbackAttr} />`;
    return `${initials}${img}`;
  }

  function getDisplayName(item) {
    if (item.fullName) return item.fullName;
    const first = item.user?.firstName || "";
    const last = item.user?.lastName || "";
    const joined = `${first} ${last}`.trim();
    return joined || "Пользователь";
  }

  async function loadProfile() {
    const res = await fetch(`/api/admin/profile${query}`, { headers: initHeaders });
    if (!res.ok) return;
    const data = await res.json();
    const admin = data.admin;
    if (!admin) return;

    const profileEl = document.getElementById("adminProfile");
    const avatar = renderAvatarImage(admin.photoUrl, admin.telegramId, getInitials(admin), "Фото профиля");

    profileEl.innerHTML = `
      <div class="flex items-center gap-4">
        <div class="relative flex h-14 w-14 items-center justify-center overflow-hidden rounded-xl bg-slate-100 text-lg font-semibold text-slate-500">
          ${avatar}
        </div>
        <div>
          <div class="text-base font-semibold text-slate-900">${admin.firstName || "Админ"} ${admin.lastName || ""}</div>
          <div class="text-sm text-slate-500">@${admin.username || "username не задан"}</div>
          <div class="text-xs text-slate-400">Telegram ID: ${admin.telegramId}</div>
        </div>
      </div>
    `;
  }

  async function loadSummary() {
    const res = await fetch(`/api/admin/summary${query}`, { headers: initHeaders });
    if (!res.ok) return;
    const data = await res.json();
    const summary = data.summary || {};

    const summaryEl = document.getElementById("summaryStats");
    summaryEl.innerHTML = `
      <div class="flex items-center justify-between py-2 text-slate-500">
        <span>Заявки на тренировки</span>
        <span class="font-semibold text-slate-900">${summary.pendingTraining || 0}</span>
      </div>
      <div class="flex items-center justify-between py-2 text-slate-500">
        <span>Принятых тренировок</span>
        <span class="font-semibold text-slate-900">${summary.accepted || 0}</span>
      </div>
      <div class="flex items-center justify-between py-2 text-slate-500">
        <span>Заявки на питание</span>
        <span class="font-semibold text-slate-900">${summary.pendingNutrition || 0}</span>
      </div>
      <div class="flex items-center justify-between py-2 text-slate-500">
        <span>Принятых планов питания</span>
        <span class="font-semibold text-slate-900">${summary.nutritionAccepted || 0}</span>
      </div>
      <div class="flex items-center justify-between py-2 text-slate-500">
        <span>Активных целей</span>
        <span class="font-semibold text-slate-900">${summary.goals || 0}</span>
      </div>
    `;
  }

  async function loadTrainings() {
    const res = await fetch(`/api/admin/trainings${query}`, { headers: initHeaders });
    const listEl = document.getElementById("trainingList");
    if (!res.ok) {
      listEl.innerHTML = `
        <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
          Не удалось загрузить тренировки.
        </div>
      `;
      return;
    }
    const data = await res.json();
    const items = data.items || [];
    if (!items.length) {
      listEl.innerHTML = `
        <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
          Пока нет принятых тренировок.
        </div>
      `;
      return;
    }

    listEl.innerHTML = items
      .map((item) => {
        const statusClass = statusClasses[item.status] || statusClasses.pending;
        const fileLinks = item.attachmentUrl
          ? `
              <div class="mt-2 flex flex-wrap gap-2">
                <a class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" href="${item.attachmentUrl}" download>
                  Скачать
                </a>
                <a class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-blue-700 transition hover:bg-blue-50" href="/admin/trainings/${item.id}/file">
                  Открыть
                </a>
              </div>
            `
          : "";

        const completeButton =
          item.status === "accepted"
            ? `<button class="mt-2 inline-flex items-center justify-center rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" data-action="complete" data-order-id="${item.id}">
                Завершить
              </button>`
            : "";
        const deleteButton = `<button class="mt-2 inline-flex items-center justify-center rounded-lg border border-rose-200 px-3 py-2 text-xs font-semibold text-rose-600 transition hover:bg-rose-50" data-action="delete" data-order-id="${item.id}">
                Удалить
              </button>`;

        return `
          <div class="rounded-xl border border-slate-200 bg-white px-4 py-4">
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm font-semibold text-slate-900">Тренировка</div>
              <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${statusClass}">
                ${statusLabels[item.status] || "Статус"}
              </span>
            </div>
            <div class="mt-3 grid gap-2 text-sm text-slate-500">
              <div class="flex items-center justify-between">
                <span>Цель</span>
                <span class="font-medium text-slate-900">${item.goalTitle || "Не указана"}</span>
              </div>
              <div class="flex items-center justify-between gap-3">
                <span>Пользователь</span>
                <span class="flex items-center gap-2 text-right">
                  <span class="relative flex h-7 w-7 items-center justify-center overflow-hidden rounded-full bg-slate-100 text-[10px] font-semibold text-slate-500">
                    ${renderAvatarImage(item.user?.photoUrl, item.user?.telegramId, getInitials(item.user), "Фото")}
                  </span>
                  <span class="font-medium text-slate-900">${getDisplayName(item)}</span>
                </span>
              </div>
              <div class="flex items-center justify-between">
                <span>Telegram ID</span>
                <span class="font-medium text-slate-900">tg:${item.telegramUserId}</span>
              </div>
              <div class="flex items-center justify-between">
                <span>Телефон</span>
                <span class="font-medium text-slate-900">${item.phoneNumber || "не указан"}</span>
              </div>
              ${fileLinks}
              ${completeButton}
              ${deleteButton}
            </div>
          </div>
        `;
      })
      .join("");
  }

  loadProfile();
  loadSummary();
  loadTrainings();

  async function loadNutritionPlans() {
    const res = await fetch(`/api/admin/nutrition/plans${query}`, { headers: initHeaders });
    const listEl = document.getElementById("nutritionList");
    if (!res.ok) {
      listEl.innerHTML = `
        <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
          Не удалось загрузить планы питания.
        </div>
      `;
      return;
    }
    const data = await res.json();
    const items = data.items || [];
    if (!items.length) {
      listEl.innerHTML = `
        <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
          Пока нет принятых планов питания.
        </div>
      `;
      return;
    }

    listEl.innerHTML = items
      .map((item) => {
        const statusClass = statusClasses[item.status] || statusClasses.pending;
        const fileLinks = item.attachmentUrl
          ? `
              <div class="mt-2 flex flex-wrap gap-2">
                <a class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" href="${item.attachmentUrl}" download>
                  Скачать
                </a>
                <a class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-blue-700 transition hover:bg-blue-50" href="/admin/nutrition/${item.id}/file">
                  Открыть
                </a>
              </div>
            `
          : "";

        const completeButton =
          item.status === "accepted"
            ? `<button class="mt-2 inline-flex items-center justify-center rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" data-action="nutrition-complete" data-order-id="${item.id}">
                Завершить
              </button>`
            : "";

        const deleteButton = `<button class="mt-2 inline-flex items-center justify-center rounded-lg border border-rose-200 px-3 py-2 text-xs font-semibold text-rose-600 transition hover:bg-rose-50" data-action="nutrition-delete" data-order-id="${item.id}">
                Удалить
              </button>`;

        const goalLabel =
          item.nutritionGoal === "loss"
            ? "Похудение"
            : item.nutritionGoal === "mass"
              ? "Набор массы"
              : item.nutritionGoal === "quality"
                ? "Качество тела"
                : "Не указана";

        return `
          <div class="rounded-xl border border-slate-200 bg-white px-4 py-4">
            <div class="flex items-center justify-between gap-3">
              <div class="text-sm font-semibold text-slate-900">Питание</div>
              <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${statusClass}">
                ${statusLabels[item.status] || "Статус"}
              </span>
            </div>
            <div class="mt-3 grid gap-2 text-sm text-slate-500">
              <div class="flex items-center justify-between">
                <span>Цель</span>
                <span class="font-medium text-slate-900">${goalLabel}</span>
              </div>
              <div class="flex items-center justify-between gap-3">
                <span>Пользователь</span>
                <span class="flex items-center gap-2 text-right">
                  <span class="relative flex h-7 w-7 items-center justify-center overflow-hidden rounded-full bg-slate-100 text-[10px] font-semibold text-slate-500">
                    ${renderAvatarImage(item.user?.photoUrl, item.user?.telegramId, getInitials(item.user), "Фото")}
                  </span>
                  <span class="font-medium text-slate-900">${getDisplayName(item)}</span>
                </span>
              </div>
              <div class="flex items-center justify-between">
                <span>Telegram ID</span>
                <span class="font-medium text-slate-900">tg:${item.telegramUserId}</span>
              </div>
              <div class="flex items-center justify-between">
                <span>Телефон</span>
                <span class="font-medium text-slate-900">${item.phoneNumber || "не указан"}</span>
              </div>
              ${fileLinks}
              ${completeButton}
              ${deleteButton}
            </div>
          </div>
        `;
      })
      .join("");
  }

  loadNutritionPlans();

  const tabTrainingPlans = document.getElementById("tabTrainingPlans");
  const tabNutritionPlans = document.getElementById("tabNutritionPlans");

  function setActivePlansTab(tab) {
    const isTraining = tab === "training";
    document.getElementById("trainingList").classList.toggle("hidden", !isTraining);
    document.getElementById("nutritionList").classList.toggle("hidden", isTraining);

    tabTrainingPlans.classList.toggle("border-blue-200", isTraining);
    tabTrainingPlans.classList.toggle("bg-blue-50", isTraining);
    tabTrainingPlans.classList.toggle("text-blue-700", isTraining);
    tabTrainingPlans.classList.toggle("border-slate-200", !isTraining);
    tabTrainingPlans.classList.toggle("text-slate-500", !isTraining);

    tabNutritionPlans.classList.toggle("border-blue-200", !isTraining);
    tabNutritionPlans.classList.toggle("bg-blue-50", !isTraining);
    tabNutritionPlans.classList.toggle("text-blue-700", !isTraining);
    tabNutritionPlans.classList.toggle("border-slate-200", isTraining);
    tabNutritionPlans.classList.toggle("text-slate-500", isTraining);
  }

  tabTrainingPlans.addEventListener("click", () => setActivePlansTab("training"));
  tabNutritionPlans.addEventListener("click", () => setActivePlansTab("nutrition"));

  document.getElementById("trainingList").addEventListener("click", async (event) => {
    const button = event.target.closest("button[data-action]");
    if (!button) return;
    const action = button.dataset.action;
    const orderId = button.dataset.orderId;
    if (!orderId) return;

    if (action === "delete") {
      const confirmed = window.confirm("Удалить тренировку?");
      if (!confirmed) return;
    }

    button.disabled = true;
    const endpoint =
      action === "delete"
        ? `/api/admin/trainings/${orderId}/delete${query}`
        : `/api/admin/trainings/${orderId}/complete${query}`;
    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...initHeaders },
      body: JSON.stringify({ adminTelegramId: adminId ? Number(adminId) : undefined }),
    });
    if (res.ok) {
      loadTrainings();
      loadSummary();
    } else {
      button.disabled = false;
      alert(action === "delete" ? "Не удалось удалить тренировку." : "Не удалось завершить тренировку.");
    }
  });

  document.getElementById("nutritionList").addEventListener("click", async (event) => {
    const button = event.target.closest("button[data-action]");
    if (!button) return;
    const action = button.dataset.action;
    const orderId = button.dataset.orderId;
    if (!orderId) return;

    if (action === "nutrition-delete") {
      const confirmed = window.confirm("Удалить план питания?");
      if (!confirmed) return;
    }

    button.disabled = true;
    const endpoint =
      action === "nutrition-delete"
        ? `/api/admin/nutrition/plans/${orderId}/delete${query}`
        : `/api/admin/nutrition/plans/${orderId}/complete${query}`;
    const res = await fetch(endpoint, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...initHeaders },
      body: JSON.stringify({ adminTelegramId: adminId ? Number(adminId) : undefined }),
    });
    if (res.ok) {
      loadNutritionPlans();
    } else {
      button.disabled = false;
      alert(action === "nutrition-delete" ? "Не удалось удалить план питания." : "Не удалось завершить план питания.");
    }
  });
</script>
