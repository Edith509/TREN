<% layout("/miniapp/layout.ejs") %>

<section class="grid gap-6 animate-[fadeSlide_0.45s_ease]">
  <section class="rounded-2xl border border-slate-200 bg-white p-5" id="profileCard">
    <div class="flex items-center gap-4">
      <div class="flex h-14 w-14 items-center justify-center rounded-xl bg-slate-100 text-lg font-semibold text-slate-500">
        ?
      </div>
      <div>
        <div class="text-base font-semibold text-slate-900">Профиль</div>
        <div class="text-sm text-slate-500">Загружаем данные...</div>
      </div>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-200 bg-white p-5">
    <div class="grid gap-3">
      <div class="text-sm font-semibold text-slate-900">Курсы</div>
      <div class="grid gap-3 md:grid-cols-2">
        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-sm font-semibold text-slate-900">Тренировки + питание</div>
          <div class="mt-1 text-xs text-slate-500">10 видео · план питания · консультация</div>
          <button
            class="mt-4 inline-flex items-center justify-center rounded-lg bg-slate-900 px-4 py-2 text-xs font-semibold text-white transition hover:bg-slate-800"
            type="button"
            data-action="buy"
          >
            Купить курс
          </button>
        </div>
        <div class="rounded-xl border border-slate-200 bg-slate-50 p-4">
          <div class="text-sm font-semibold text-slate-900">Видео МФР</div>
          <div class="mt-1 text-xs text-slate-500">8 видео · мобильность · восстановление</div>
          <button
            class="mt-4 inline-flex items-center justify-center rounded-lg bg-slate-900 px-4 py-2 text-xs font-semibold text-white transition hover:bg-slate-800"
            type="button"
            data-action="buy"
          >
            Купить курс
          </button>
        </div>
      </div>
    </div>
  </section>

  <section class="rounded-2xl border border-slate-200 bg-white p-5">
    <div class="flex items-center justify-between gap-3">
      <div class="text-sm font-semibold text-slate-900">Мои заявки</div>
      <div class="text-xs text-slate-500" id="ordersCount">0</div>
    </div>
    <div class="mt-4 flex flex-wrap gap-2">
      <button
        class="rounded-full border border-blue-200 bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700"
        type="button"
        id="tabTraining"
      >
        Тренировки
      </button>
      <button
        class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-500"
        type="button"
        id="tabNutrition"
      >
        Питание
      </button>
    </div>
    <div class="mt-4 grid gap-3" id="ordersList">
      <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
        Загружаем список...
      </div>
    </div>
  </section>
</section>

<div id="comingSoonModal" class="fixed inset-0 z-30 hidden items-center justify-center bg-slate-900/40 px-4">
  <div class="w-full max-w-sm rounded-2xl bg-white p-6 shadow-xl">
    <div class="text-base font-semibold text-slate-900">В разработке</div>
    <p class="mt-2 text-sm text-slate-500">Оплата и выдача курсов скоро будут доступны.</p>
    <div class="mt-5 flex justify-end">
      <button
        id="closeModal"
        class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-50"
        type="button"
      >
        Закрыть
      </button>
    </div>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const telegramId = document.body.dataset.telegramId || params.get("telegramId");
  const initData = window.Telegram?.WebApp?.initData || "";
  const initHeaders = initData ? { "x-telegram-init-data": initData } : {};
  const query = telegramId ? `?telegramId=${telegramId}` : "";
  const tabTraining = document.getElementById("tabTraining");
  const tabNutrition = document.getElementById("tabNutrition");
  let activeTab = "training";

  const statusLabels = {
    pending: "Подано",
    accepted: "Активна",
    declined: "Отклонено",
    completed: "Завершено",
  };

  const statusClasses = {
    pending: "border border-blue-200 bg-blue-50 text-blue-700",
    accepted: "border border-emerald-200 bg-emerald-50 text-emerald-700",
    declined: "border border-rose-200 bg-rose-50 text-rose-600",
    completed: "border border-indigo-200 bg-indigo-50 text-indigo-700",
  };

  function formatDate(value) {
    if (!value) return "Дата не задана";
    const date = new Date(value);
    return date.toLocaleDateString("ru-RU", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    });
  }

  function getInitials(profile) {
    const first = profile?.firstName?.[0] || "";
    const last = profile?.lastName?.[0] || "";
    return `${first}${last}`.trim() || "?";
  }

  function renderAvatarImage(photoUrl, telegramId, initials, altText) {
    const fallbackSrc = telegramId ? `/api/telegram/avatar/${telegramId}` : "";
    const src = photoUrl || fallbackSrc;
    if (!src) return initials;
    const fallbackAttr = fallbackSrc && src !== fallbackSrc ? ` data-fallback="${fallbackSrc}"` : "";
    const onError = "if (this.dataset.fallback){this.src=this.dataset.fallback;this.removeAttribute('data-fallback');}else{this.remove();}";
    const img = `<img class="absolute inset-0 h-full w-full object-cover" src="${src}" alt="${altText}" onerror="${onError}"${fallbackAttr} />`;
    return `${initials}${img}`;
  }

  function setRequestButtonState(canRequest, message) {
    const button = document.getElementById("requestTrainingButton");
    const notice = document.getElementById("requestNotice");
    if (!button || !notice) return;

    if (canRequest) {
      button.classList.remove("opacity-50", "pointer-events-none");
      notice.classList.add("hidden");
      notice.textContent = "";
    } else {
      button.classList.add("opacity-50", "pointer-events-none");
      notice.textContent = message || "У вас уже есть активная или поданная заявка.";
      notice.classList.remove("hidden");
    }
  }

  function setNutritionButtonState(canRequest, message) {
    const button = document.getElementById("requestNutritionButton");
    const notice = document.getElementById("nutritionNotice");
    if (!button || !notice) return;

    if (canRequest) {
      button.classList.remove("opacity-50", "pointer-events-none");
      notice.classList.add("hidden");
      notice.textContent = "";
    } else {
      button.classList.add("opacity-50", "pointer-events-none");
      notice.textContent = message || "У вас уже есть активная или поданная заявка.";
      notice.classList.remove("hidden");
    }
  }

  async function loadProfile() {
    if (!telegramId && !initData) {
      setRequestButtonState(false, "Не указан Telegram ID.");
      setNutritionButtonState(false, "Не указан Telegram ID.");
      return;
    }
    const res = await fetch(`/api/miniapp/profile${query}`, { headers: initHeaders });
    if (!res.ok) {
      setRequestButtonState(false, "Не удалось загрузить профиль.");
      setNutritionButtonState(false, "Не удалось загрузить профиль.");
      return;
    }
    const data = await res.json();
    const user = data.user;
    const profileCard = document.getElementById("profileCard");

    if (profileCard) {
      const avatar = renderAvatarImage(user.photoUrl, user.telegramId, getInitials(user), "Фото профиля");
      profileCard.innerHTML = `
        <div class="flex items-center gap-4">
          <div class="relative flex h-14 w-14 items-center justify-center overflow-hidden rounded-xl bg-slate-100 text-lg font-semibold text-slate-500">
            ${avatar}
          </div>
          <div>
            <div class="text-base font-semibold text-slate-900">${user.firstName || "Пользователь"} ${user.lastName || ""}</div>
            <div class="text-sm text-slate-500">@${user.username || "username не задан"}</div>
          </div>
        </div>
      `;
    }

    if (user.isAdmin) {
      setRequestButtonState(false, "Админы не подают заявки.");
      setNutritionButtonState(false, "Админы не подают заявки.");
      return;
    }

    const hasOpenRequest =
      user.trainingStatus === "active" || user.trainingStatus === "requested";
    setRequestButtonState(!hasOpenRequest);

    const hasNutritionRequest =
      user.nutritionStatus === "active" || user.nutritionStatus === "requested";
    setNutritionButtonState(!hasNutritionRequest);
  }

  function renderTrainingOrders(items) {
    return items
      .map((item) => {
        const statusClass = statusClasses[item.status] || statusClasses.pending;
        const fileLinks = item.attachmentUrl
          ? `
              <div class="mt-2 flex flex-wrap gap-2">
                <a class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" href="${item.attachmentUrl}" download>
                  <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path d="M10 2a.75.75 0 0 1 .75.75v7.69l2.22-2.22a.75.75 0 1 1 1.06 1.06l-3.5 3.5a.75.75 0 0 1-1.06 0l-3.5-3.5a.75.75 0 1 1 1.06-1.06l2.22 2.22V2.75A.75.75 0 0 1 10 2z" />
                    <path d="M4 13.25A.75.75 0 0 1 4.75 12.5h10.5a.75.75 0 0 1 .75.75v2.5A2.25 2.25 0 0 1 13.75 18h-7.5A2.25 2.25 0 0 1 4 15.75v-2.5z" />
                  </svg>
                  Скачать
                </a>
                <a class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-blue-700 transition hover:bg-blue-50" href="/miniapp/trainings/${item.id}/file${query}">
                  <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path d="M4.75 3A1.75 1.75 0 0 0 3 4.75v10.5A1.75 1.75 0 0 0 4.75 17h10.5A1.75 1.75 0 0 0 17 15.25V8.5a.75.75 0 0 0-.22-.53l-3.75-3.75A.75.75 0 0 0 12.5 4H4.75zM12 5.5V8h2.5L12 5.5zM6 10.25c0-.414.336-.75.75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5A.75.75 0 0 1 6 10.25zm0 3c0-.414.336-.75.75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5A.75.75 0 0 1 6 13.25z" />
                  </svg>
                  Открыть
                </a>
              </div>
            `
          : "";

        return `
          <div class="rounded-xl border border-slate-200 bg-white px-4 py-4">
            <div class="flex items-center justify-between gap-2">
              <div class="text-sm font-medium text-slate-900">${formatDate(item.trainingDate)}</div>
              <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${statusClass}">
                ${statusLabels[item.status] || "Статус"}
              </span>
            </div>
            <div class="mt-2 text-sm text-slate-500">
              <div class="flex items-center justify-between">
                <span>Цель</span>
                <span class="font-medium text-slate-900">${item.goalTitle || "Не указана"}</span>
              </div>
            </div>
            ${fileLinks}
          </div>
        `;
      })
      .join("");
  }

  function renderNutritionOrders(items) {
    return items
      .map((item) => {
        const statusClass = statusClasses[item.status] || statusClasses.pending;
        const fileLinks = item.attachmentUrl
          ? `
              <div class="mt-2 flex flex-wrap gap-2">
                <a class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50" href="${item.attachmentUrl}" download>
                  <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path d="M10 2a.75.75 0 0 1 .75.75v7.69l2.22-2.22a.75.75 0 1 1 1.06 1.06l-3.5 3.5a.75.75 0 0 1-1.06 0l-3.5-3.5a.75.75 0 1 1 1.06-1.06l2.22 2.22V2.75A.75.75 0 0 1 10 2z" />
                    <path d="M4 13.25A.75.75 0 0 1 4.75 12.5h10.5a.75.75 0 0 1 .75.75v2.5A2.25 2.25 0 0 1 13.75 18h-7.5A2.25 2.25 0 0 1 4 15.75v-2.5z" />
                  </svg>
                  Скачать
                </a>
                <a class="inline-flex items-center gap-2 rounded-lg border border-slate-200 px-3 py-2 text-xs font-semibold text-blue-700 transition hover:bg-blue-50" href="/miniapp/nutrition/${item.id}/file${query}">
                  <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path d="M4.75 3A1.75 1.75 0 0 0 3 4.75v10.5A1.75 1.75 0 0 0 4.75 17h10.5A1.75 1.75 0 0 0 17 15.25V8.5a.75.75 0 0 0-.22-.53l-3.75-3.75A.75.75 0 0 0 12.5 4H4.75zM12 5.5V8h2.5L12 5.5zM6 10.25c0-.414.336-.75.75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5A.75.75 0 0 1 6 10.25zm0 3c0-.414.336-.75.75-.75h6.5a.75.75 0 0 1 0 1.5h-6.5A.75.75 0 0 1 6 13.25z" />
                  </svg>
                  Открыть
                </a>
              </div>
            `
          : "";

        const goalLabel =
          item.nutritionGoal === "loss"
            ? "Похудение"
            : item.nutritionGoal === "mass"
              ? "Набор массы"
              : item.nutritionGoal === "quality"
                ? "Качество тела"
                : "Не указана";

        return `
          <div class="rounded-xl border border-slate-200 bg-white px-4 py-4">
            <div class="flex items-center justify-between gap-2">
              <div class="text-sm font-medium text-slate-900">${formatDate(item.createdAt)}</div>
              <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold ${statusClass}">
                ${statusLabels[item.status] || "Статус"}
              </span>
            </div>
            <div class="mt-2 text-sm text-slate-500">
              <div class="flex items-center justify-between">
                <span>Цель питания</span>
                <span class="font-medium text-slate-900">${goalLabel}</span>
              </div>
            </div>
            ${fileLinks}
          </div>
        `;
      })
      .join("");
  }

  async function loadOrders() {
    const listEl = document.getElementById("ordersList");
    const countEl = document.getElementById("ordersCount");
    if (!telegramId && !initData) {
      if (countEl) {
        countEl.textContent = "0";
      }
      if (listEl) {
        listEl.innerHTML = `
          <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
            Не указан Telegram ID.
          </div>
        `;
      }
      return;
    }
    const endpoint =
      activeTab === "nutrition" ? "/api/miniapp/nutrition/orders" : "/api/miniapp/orders";
    const res = await fetch(`${endpoint}${query}`, { headers: initHeaders });

    if (!res.ok) {
      if (listEl) {
        listEl.innerHTML = `
          <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
            Не удалось загрузить заявки.
          </div>
        `;
      }
      return;
    }

    const data = await res.json();
    const items = data.items || [];

    if (countEl) {
      countEl.textContent = `${items.length}`;
    }

    if (!listEl) return;
    if (!items.length) {
      listEl.innerHTML = `
        <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-5 text-center text-sm text-slate-500">
          Пока нет заявок.
        </div>
      `;
      return;
    }

    listEl.innerHTML =
      activeTab === "nutrition" ? renderNutritionOrders(items) : renderTrainingOrders(items);
  }

  if (telegramId) {
    const requestTrainingButton = document.getElementById("requestTrainingButton");
    const requestNutritionButton = document.getElementById("requestNutritionButton");
    if (requestTrainingButton) {
      requestTrainingButton.href = `/miniapp/request?telegramId=${telegramId}`;
    }
    if (requestNutritionButton) {
      requestNutritionButton.href = `/miniapp/nutrition/request?telegramId=${telegramId}`;
    }
  }

  function setActiveTab(nextTab) {
    activeTab = nextTab;
    if (tabTraining && tabNutrition) {
      const isTraining = nextTab === "training";
      tabTraining.classList.toggle("border-blue-200", isTraining);
      tabTraining.classList.toggle("bg-blue-50", isTraining);
      tabTraining.classList.toggle("text-blue-700", isTraining);
      tabTraining.classList.toggle("border-slate-200", !isTraining);
      tabTraining.classList.toggle("text-slate-500", !isTraining);

      tabNutrition.classList.toggle("border-blue-200", !isTraining);
      tabNutrition.classList.toggle("bg-blue-50", !isTraining);
      tabNutrition.classList.toggle("text-blue-700", !isTraining);
      tabNutrition.classList.toggle("border-slate-200", isTraining);
      tabNutrition.classList.toggle("text-slate-500", isTraining);
    }
    loadOrders();
  }

  tabTraining?.addEventListener("click", () => setActiveTab("training"));
  tabNutrition?.addEventListener("click", () => setActiveTab("nutrition"));

  loadProfile();
  loadOrders();

  const modal = document.getElementById("comingSoonModal");
  const closeModal = document.getElementById("closeModal");

  if (modal && closeModal) {
    document.querySelectorAll("[data-action='buy']").forEach((button) => {
      button.addEventListener("click", () => {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      });
    });

    closeModal.addEventListener("click", () => {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    });

    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }
    });
  }
</script>
