<% layout("/miniapp/layout.ejs") %>

<section class="grid gap-6 animate-[fadeSlide_0.45s_ease]">
  <section class="rounded-2xl border border-slate-200 bg-white p-5">
    <h1 class="text-xl font-semibold text-slate-900">Раздел заявок</h1>
    <p class="mt-2 text-sm text-slate-500">Здесь можно подать заявку на тренировки или питание. После рассмотрения заявки, прикрепленную тренировку можно будет найти в разделе "Мои заявки".</p>
  </section>

  <section class="rounded-2xl border border-slate-200 bg-white p-5" id="requestBlock">
    <div class="grid gap-4">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="text-sm font-semibold text-slate-900">Новые заявки</div>
        <div class="text-xs text-slate-500">Тренировки и питание</div>
      </div>
      <div class="flex flex-wrap gap-3">
        <a
          id="requestTrainingButton"
          class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-xs font-semibold text-white transition hover:bg-blue-500"
          href="/miniapp/request"
        >
          Заявка на тренировку
        </a>
        <a
          id="requestNutritionButton"
          class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-700 transition hover:bg-slate-50"
          href="/miniapp/nutrition/request"
        >
          Заявка на питание
        </a>
      </div>
    </div>
    <div
      id="requestNotice"
      class="mt-3 hidden rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700"
    ></div>
    <div
      id="nutritionNotice"
      class="mt-2 hidden rounded-lg border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700"
    ></div>
  </section>
</section>

<script>
  const params = new URLSearchParams(window.location.search);
  const telegramId = document.body.dataset.telegramId || params.get("telegramId");
  const initData = window.Telegram?.WebApp?.initData || "";
  const initHeaders = initData ? { "x-telegram-init-data": initData } : {};
  const query = telegramId ? `?telegramId=${telegramId}` : "";

  if (telegramId) {
    const requestTrainingButton = document.getElementById("requestTrainingButton");
    const requestNutritionButton = document.getElementById("requestNutritionButton");
    if (requestTrainingButton) {
      requestTrainingButton.href = `/miniapp/request?telegramId=${telegramId}`;
    }
    if (requestNutritionButton) {
      requestNutritionButton.href = `/miniapp/nutrition/request?telegramId=${telegramId}`;
    }
  }

  function setRequestButtonState(canRequest, message) {
    const button = document.getElementById("requestTrainingButton");
    const notice = document.getElementById("requestNotice");
    if (!button || !notice) return;

    if (canRequest) {
      button.classList.remove("opacity-50", "pointer-events-none");
      notice.classList.add("hidden");
      notice.textContent = "";
    } else {
      button.classList.add("opacity-50", "pointer-events-none");
      notice.textContent = message || "У вас уже есть активная или поданная заявка.";
      notice.classList.remove("hidden");
    }
  }

  function setNutritionButtonState(canRequest, message) {
    const button = document.getElementById("requestNutritionButton");
    const notice = document.getElementById("nutritionNotice");
    if (!button || !notice) return;

    if (canRequest) {
      button.classList.remove("opacity-50", "pointer-events-none");
      notice.classList.add("hidden");
      notice.textContent = "";
    } else {
      button.classList.add("opacity-50", "pointer-events-none");
      notice.textContent = message || "У вас уже есть активная или поданная заявка.";
      notice.classList.remove("hidden");
    }
  }

  async function loadProfile() {
    if (!telegramId && !initData) {
      setRequestButtonState(false, "Не указан Telegram ID.");
      setNutritionButtonState(false, "Не указан Telegram ID.");
      return;
    }
    const res = await fetch(`/api/miniapp/profile${query}`, { headers: initHeaders });
    if (!res.ok) {
      setRequestButtonState(false, "Не удалось загрузить профиль.");
      setNutritionButtonState(false, "Не удалось загрузить профиль.");
      return;
    }
    const data = await res.json();
    const user = data.user;

    if (user?.isAdmin) {
      setRequestButtonState(false, "Админы не подают заявки.");
      setNutritionButtonState(false, "Админы не подают заявки.");
      return;
    }

    const hasOpenRequest =
      user?.trainingStatus === "active" || user?.trainingStatus === "requested";
    setRequestButtonState(!hasOpenRequest);

    const hasNutritionRequest =
      user?.nutritionStatus === "active" || user?.nutritionStatus === "requested";
    setNutritionButtonState(!hasNutritionRequest);
  }

  loadProfile();
</script>
